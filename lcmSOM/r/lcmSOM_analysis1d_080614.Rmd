#Getting the most sig. differentiated genes between tissue

##Purpose
This should be the last analaysis of the original SOM.  This analysis is a follow-up to `lcmSOM_analysis1c_080514.Rmd`, where the original scaling will be done specific to genotype.  

##Required Libraries

```{r}
library(ggplot2)
library(reshape)
library(kohonen)
```

Self Organizing Maps 
========================================================

##1.pca.R

First read in file that came from mostSigDEgenes.Rmd.  This is a list of genes from all DE analysis in WT. They were all cancatenated, then duplicate genes were removed.  In addition the mean was calculated from the replicates of each type. 

The first step is to get it into the right format. First column being the genes, while the subsequent columns are the different libraries (type).

```{r}
mostDEgenes <- read.csv("../data/allGeneListBothGenotypes_analysis5b.csv")
head(mostDEgenes)

mostDEgenes <- mostDEgenes[c(7, 1, 2, 4)] #keep only needed columns (gene, type, mean)

#Change from long to wide data format
mostDEgene.long <- cast(mostDEgenes, genotype + gene ~ type, value.var = mean, fun.aggregate = "mean")  #why did I have to specify "mean" here? Are there duplicates of types? Double check later. 
mostDEgene.long <- as.data.frame(mostDEgene.long)  
head(mostDEgene.long)
```

At this point I am going to subset on genotype and scale seperatley before adding them back together. **THIS  IS THE ONLY PART DIFFERENT FROM analysis`lcmSOM_analysis1c_080514.Rmd`**

```{r}
wt <- subset(mostDEgene.long, genotype == "wt")
tf2 <- subset(mostDEgene.long, genotype == "tf2")

scale_data.wt <- as.matrix(t(scale(t(wt[c(3:8)]))))#transformation.
scale_data.tf2 <- as.matrix(t(scale(t(tf2[c(3:8)]))))#transformation.

scale_data <- rbind(scale_data.wt, scale_data.tf2)
```

```{r}
#Principle Component Analysis
pca <- prcomp(scale_data, scale=TRUE) 

summary(pca) 

pca.scores <- data.frame(pca$x)

data.val <- cbind(mostDEgene.long, scale_data, pca.scores) 
head(data.val)
```

##Visualizing the PCA

Looks to be three major clusters. 

```{r}
p <- ggplot(data.val, aes(PC1, PC2)) 
p + geom_point(alpha = .6)
```

------------

*I am skipping the large Map and going straight to the small*

2. Self Organizing Map- Small (3,2)
-----------------------------

The size of the map is something that may cause differences in the genes that are clustered.  Using a small map size (3,2), I found they cluster in according to tissue type. See below.

```{r}
names(data.val)
som.data <- as.matrix(data.val[,c(9:14)])
head(som.data)
set.seed(5)

som <- som(data=som.data, somgrid(3,2,"hexagonal")) # This is where you change the size of the map

summary(som)
```

###Training Plot ("changes") - Small

This shows a hundred iterations. Training plateaus at around 20 iterations steeply.  Is this a problem?

```{r}
plot(som, type ="changes")
```

###Code Plot - Small

Here with the small map, each tissue has a tissue specific cluster. 

```{r}
plot(som, type = "codes")
```

###Count Plot - Small

This tells you how many genes are in each of the clusters. 

```{r}
plot(som, type = "counts")
```

###Distance Neighbour Plot- Small

This is sometimes called the "U-Matrix", it can help identify further clustering. Areas of low neighbour distance indicate groups of nodes that are similar and the further apart nodes indicate natural "borders" in the map. 

```{r}
plot(som, type="dist.neighbours")
```

###Heatmaps - Small 

This shows the distribution of each type of tissue.  This doesn't really work too well when the the map is so small. Bother is the only tissue type that contributes to two clusters. 

```{r}
head(som$codes)
som$data <- data.frame(som$data) #changed to dataframe to extract column names easier. 

#This is just a loop that plots the distrinution of each tissue type across the map. 
for (i in 1:6){
  plot(som, type = "property", property = som$codes[,i], main=names(som$data)[i])
  print(plot)
  }
```

Output
```{r}
data.val.small <- cbind(data.val,som$unit.classif,som$distances)
head(data.val.small)
write.table(data.val.small, file="../data/analysis1.som.data.small.ALLD.txt")
#Make sure that there is just one of each value som$unit.classif and distances column. 
names(data.val.small)
```

#Other Visualization 

###Visualize by Cluster

```{r}
plot.data <- read.table("../data/analysis1.som.data.small.ALLD.txt",header=TRUE)
names(plot.data)

p <- ggplot(plot.data, aes(PC1, PC2, colour=factor(som.unit.classif))) #use unit.classif for smaller dataset
p + geom_point(alpha = .6) + facet_grid(.~genotype) + theme_bw()
```


##Cluster Specific analysis
Now I want to take a look at what are is going on exactly in these clusters. The clusters start with the bottom left, which is cluster one and is 

```{r}
plot(som, type = "codes")
```

head(plot.data)
This is a function that spits out the variables I want.  I should write 
```{r}
#clusterVis Function
#displays transformed data in a box plot and 
clusterVis <- function(clustNum){
  
  sub_cluster <- subset(plot.data, som.unit.classif==clustNum)
  sub_data <- sub_cluster[,9:14] # just the sample types
  m.data <- melt(sub_data) 
  p <- ggplot(m.data, aes(x=variable, y=value))
  p + geom_point(alpha=0.5, position="jitter", size=1) + geom_boxplot(alpha=0.75, outlier.size=0) 
}

#Number of genes function, which gives you some basics about the clusters between 

clusterNum <- function(clustNum){

  sub_cluster <- subset(plot.data, som.unit.classif==clustNum)
  print(paste("total number of genes in sub cluster is ", 
              nrow(sub_cluster)
              )
        )

  scwt <- subset(sub_cluster, genotype == "wt")
  print(paste("total number of genes specific to wt is ", 
              nrow(scwt)
              )
        )

  sctf2 <- subset(sub_cluster, genotype == "tf2")
  print(paste("total number of genes specific to wt is ", 
              nrow(sctf2)
              )
        )
  
   print(paste("There are", 
               length(intersect(scwt$gene, sctf2$gene)), 
               " that are the same between wt and tf2"
               )
         )
               
}
```
###Cluster 1

Sub cluster 1 is defined by up regulation of genes in Bmbr, which is the early leaflet region of the terminal leaflet. 

```{r}
clusterVis(1)
clusterNum(1)
```

###Cluster 2

Sub cluster 2 is defined by up regulation of genes in Cmbr, which is the base "marginal blastozone" region, which should be the most pluripotent in WT. 

```{r}
clusterVis(2)
clusterNum(2)
```

###Cluster 3

This cluster is specific to Cother, which is specific to the rachis region at the base. 

```{r}
clusterVis(3)
clusterNum(3)
```

###Cluster 4 

This cluster has genes that are preferentially up-regulated in Ambr, which is the tip most region that becomes the terminal leaflet.  This is the terminal leaflet blade region 
```{r}
clusterVis(4)
clusterNum(4)
```

###Cluster 5 

The cluster ihas genes that are preferentially up-regulated in Aother, which is the rachis region at the tip; what will eventually become the midvien of the terminal leaflet.

```{r}
clusterVis(5)
clusterNum(5)
```

###Cluster  6

The cluster ihas genes that are preferentially up-regulated in Bother, which is the rachis region at site of leaflet initiation.

```{r}
clusterVis(6)
clusterNum(6)
```

#Now to compare 
##References

```{r}


```


1. [R self Organizing map tutorial](http://www.r-bloggers.com/self-organising-maps-for-customer-segmentation-using-r/)
